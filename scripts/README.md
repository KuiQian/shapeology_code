## Guidlines for Cell Shape Analysis
## First step: Generating cell patches
This step is to extract cells from each brain section's image.
### How to run
#### 1. Extracting cells from single section
```
python Cells_extractor.py stack section
```
```
positional arguments:
  stack       The name of the brain, type=str, default='MD594'
  section     Id of the brain section, type=int, default=256
```
#### 2. Extracting cells from all images of one brain

```
python Cell_datajoint/Cells_extract_datajoint.py Environment stack
```
```
positional arguments:
  Environment  Local or AWS
  stack        The name of the brain, type=str, default='MD594'
```
This script is to conduct the whole extracting process via datajoint workflow.
#### 3. Run on multiple AWS instances
```
python Aws-jupyter.py name number
```
```
positional arguments:
  name       The name of a cluster, type=str, default='test'
  number     The number of instances to create, type=int, default=10
```
This script is to automatically create multiple AWS instances and 
send scripts to run on them parallelly. You can modify the commands in 
`..\install-project.sh` to customize your task. For example:
```
git clone -b kui_dev --single-branch https://github.com/yoavfreund/shapeology_code.git
source shapeology_code/configure.sh
cd shapeology_code/scripts/Cell_datajoint/
python Cells_extract_datajoint.py 'AWS' 'DK39'
``` 
### Relevant scripts
#### 1. extractPatches.py
Define a class to extract patches from a single tile. Called by `Cells_extractor.py`.

#### 2. patch_normalizer.py
Define a class to normalize the patches. Called by `extractPatches.py`.

#### 3. label_patch.py
Define a class for diffusion map. Called by `extractPatches.py`.

## Second step: Training for diffusion map
### Process
#### 1. Permute cells in a random order
```
python SortFile_v2.py
```
This script is to process the patch files generated by the first step
and prepare them for analysis by K-means. 
* In `Cells_extractor.py`, cells are stored in 3 files according 
to 3 padding sizes and permuted randomly already for each section.
* We create 20 files for each padding size with 100000 cells in every
file. 
* In one file, collect cells from each section based on the proportion
 of the number of cells in each section to the total. Then permute these 
 cells in a random order.

#### 2. Find representative samples via K-means
```
python CreateVQs_v2.py padded_size samples_size
```
```
positional arguments:
  padded_size    One of the three padded size, 15, 51 or 201
  samples_size   Number of samples taken for K-means
```
This script is to conclude cells into representative samples with 
a limited number.
* Find representative cells of a specific number first.
* Divide cells into clusters based on representative cells and take the 
the mean of each cluster as representative samples.

### Relevant scripts
#### 1. lib/permute.py 
Define a class that creates a random permutation of equal-size cells. 
Called by `SortFile.py`.



